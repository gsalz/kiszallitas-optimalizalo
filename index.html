<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Kisz√°ll√≠t√°s Optimaliz√°l√≥</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC5E59duGPNKibjfN7snj7yCQDfa4iDPRQ&libraries=places"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    input {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
    }
    button {
      margin-top: 10px;
      padding: 10px 15px;
      background-color: #1e90ff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0f78d1;
    }
    #map {
      margin-top: 20px;
      width: 100%;
      height: 400px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <h1>Kisz√°ll√≠t√°s optimaliz√°l√°s</h1>

  <table id="ordersTable">
    <thead>
      <tr>
        <th>C√≠m</th>
        <th>Raklap</th>
        <th>S√∫ly (kg)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" value="Klingler Klaus 21, Tarnazsad√°ny"></td>
        <td><input type="number" value="1"></td>
        <td><input type="number" value="200"></td>
      </tr>
    </tbody>
  </table>

  <button onclick="addRow()">‚ûï √öj c√≠m hozz√°ad√°sa</button>
  <button onclick="optimize()">üß† Optimaliz√°l√°s ind√≠t√°sa</button>

  <div id="result"></div>
  <div id="map"></div>

  <script>
    const depots = [
      { name: "Budapest", address: "1173 Budapest, R√©giv√°m k√∂z 6." },
      { name: "Gy≈ër", address: "9027 Gy≈ër, Csonka J√°nos u. 3." },
      { name: "Miskolc", address: "3527 Miskolc, V√°rk√∂zi Lajos utca 5." },
      { name: "Szeged", address: "6728 Szeged, Back Bern√°t u. 2." }
    ];

    const regionalZones = {
      "Gy≈ër": ["Gy≈ër", "Mosonmagyar√≥v√°r", "Kom√°rom", "Csorna"],
      "Miskolc": ["Miskolc", "Eger", "Kazincbarcika", "Tisza√∫jv√°ros"],
      "Szeged": ["Szeged", "Mak√≥", "H√≥dmez≈ëv√°s√°rhely", "Kistelek"]
    };

    let map;
    let marker;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 47.4979, lng: 19.0402 },
        zoom: 7
      });
    }

    function updateMap(address) {
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: address }, (results, status) => {
        if (status === "OK") {
          map.setCenter(results[0].geometry.location);
          map.setZoom(10);
          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location
          });
        }
      });
    }

    function addRow() {
      const table = document.querySelector("#ordersTable tbody");
      const row = document.createElement("tr");
      row.innerHTML = \`
        <td><input type="text"></td>
        <td><input type="number" value="1"></td>
        <td><input type="number" value="0"></td>
      \`;
      table.appendChild(row);
    }

    async function getBestDepot(destination) {
      const service = new google.maps.DistanceMatrixService();
      return new Promise((resolve) => {
        service.getDistanceMatrix({
          origins: depots.map(d => d.address),
          destinations: [destination],
          travelMode: 'DRIVING',
          unitSystem: google.maps.UnitSystem.METRIC
        }, (response, status) => {
          if (status !== 'OK') {
            console.error('Hiba a Google Maps lek√©rdez√©sben:', status);
            resolve({ name: "Ismeretlen", distance: null });
          } else {
            const results = response.rows.map((row, i) => ({
              name: depots[i].name,
              distance: row.elements[0].distance.value,
              duration: row.elements[0].duration.value
            }));

            const lowerDest = destination.toLowerCase();

            const nearDepot = results.find(r =>
              r.name !== "Budapest" && r.distance <= 60000
            );
            if (nearDepot) {
              resolve(nearDepot);
              return;
            }

            for (let depotName in regionalZones) {
              if (regionalZones[depotName].some(city => lowerDest.includes(city.toLowerCase()))) {
                const match = results.find(r => r.name === depotName);
                resolve(match);
                return;
              }
            }

            const budapest = results.find(r => r.name === "Budapest");
            resolve(budapest);
          }
        });
      });
    }

    async function optimize() {
      const rows = document.querySelectorAll("#ordersTable tbody tr");
      const resultList = document.getElementById("result");
      resultList.innerHTML = "<h3>Eredm√©nyek:</h3><ul>";

      for (const row of rows) {
        const cells = row.querySelectorAll("input");
        const address = cells[0].value;
        const raklap = parseFloat(cells[1].value);
        const kg = parseFloat(cells[2].value);

        const depotInfo = await getBestDepot(address);
        updateMap(address);
        resultList.innerHTML += \`<li>üìç \${address} ‚Äì \${raklap} raklap, \${kg} kg ‚Üí üöö <strong>\${depotInfo.name}</strong> (\${Math.round(depotInfo.distance / 1000)} km)</li>\`;
      }

      resultList.innerHTML += "</ul>";
    }

    window.onload = initMap;
  </script>
</body>
</html>
